<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>中文笔顺训练 · Chinese Stroke Order Training</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- MediaPipe Hands -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-content">
            <div class="brush-icon">🖌️</div>
            <h1 class="loading-title">中文笔顺训练</h1>
            <p class="loading-subtitle">Chinese Stroke Order Training</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <p class="loading-status">正在初始化...</p>
        </div>
    </div>

    <!-- Permission Screen -->
    <div id="permission-screen" class="hidden">
        <div class="permission-content">
            <div class="camera-icon">📷</div>
            <h2 id="perm-title">需要摄像头权限</h2>
            <p id="perm-desc">本应用需要使用摄像头追踪您的手指动作来识别书写笔画。</p>
            <ul class="permission-list">
                <li id="perm-item1">✓ 仅用于手指追踪，不录制视频</li>
                <li id="perm-item2">✓ 所有处理在本地完成</li>
                <li id="perm-item3">✓ 不会上传任何数据</li>
            </ul>
            <button id="btn-grant-permission" class="btn-primary">
                <span>授权摄像头</span>
            </button>
            <button id="btn-skip-camera" class="btn-secondary">
                <span>跳过（使用触屏/鼠标模式）</span>
            </button>
        </div>
    </div>

    <!-- Calibration Screen -->
    <div id="calibration-screen" class="hidden">
        <div class="calibration-content">
            <h2 id="calib-title">手指校准</h2>
            <p id="calib-desc">请将您的食指放在摄像头前方，保持稳定。</p>
            <div class="calibration-preview">
                <video id="calib-video" autoplay playsinline></video>
                <canvas id="calib-canvas"></canvas>
                <div class="calibration-target"></div>
            </div>
            <div class="calibration-status">
                <div class="status-indicator" id="finger-detected">
                    <span class="indicator-dot"></span>
                    <span id="calib-status-text">未检测到手指</span>
                </div>
            </div>
            <button id="btn-start-training" class="btn-primary" disabled>
                <span id="btn-start-text">开始训练</span>
            </button>
        </div>
    </div>

    <!-- Stroke Training Screen (Tutorial) -->
    <div id="tutorial-screen" class="hidden">
        <div class="tutorial-content">
            <header class="tutorial-header">
                <h2>📝 基础笔画训练</h2>
                <p>在开始写字之前，先练习5种基本笔画</p>
            </header>
            
            <div class="tutorial-progress">
                <div class="progress-step" data-step="heng">
                    <span class="step-icon">一</span>
                    <span class="step-name">横</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="progress-step" data-step="shu">
                    <span class="step-icon">丨</span>
                    <span class="step-name">竖</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="progress-step" data-step="pie">
                    <span class="step-icon">丿</span>
                    <span class="step-name">撇</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="progress-step" data-step="na">
                    <span class="step-icon">㇏</span>
                    <span class="step-name">捺</span>
                    <span class="step-status">⏳</span>
                </div>
                <div class="progress-step" data-step="dian">
                    <span class="step-icon">丶</span>
                    <span class="step-name">点</span>
                    <span class="step-status">⏳</span>
                </div>
            </div>

            <div class="tutorial-main">
                <div class="tutorial-demo">
                    <div class="stroke-demo-box">
                        <div class="stroke-arrow" id="stroke-arrow"></div>
                        <div class="stroke-name-big" id="tutorial-stroke-name">横</div>
                        <div class="stroke-direction" id="tutorial-direction">从左到右 →</div>
                    </div>
                </div>
                
                <div class="tutorial-practice">
                    <div class="practice-area">
                        <video id="tutorial-video" autoplay playsinline></video>
                        <canvas id="tutorial-canvas"></canvas>
                        <div class="practice-guide">
                            <div class="guide-line" id="guide-line"></div>
                        </div>
                    </div>
                    <p class="practice-hint" id="tutorial-hint">用手指画一个横 →</p>
                    <p class="pinch-tip">💡 摄像头模式：👌 捏合拇指食指开始画，松开结束</p>
                </div>
            </div>

            <div class="tutorial-controls">
                <button id="btn-clear-tutorial" class="btn-secondary">🗑️ 清除</button>
                <button id="btn-skip-tutorial" class="btn-secondary">跳过训练 →</button>
            </div>

            <div class="tutorial-feedback hidden" id="tutorial-feedback">
                <div class="feedback-icon">✓</div>
                <div class="feedback-text">很好！</div>
            </div>
        </div>
    </div>

    <!-- Main Training Screen -->
    <div id="training-screen" class="hidden">
        <!-- Header -->
        <header class="app-header">
            <a href="../index.html" class="back-btn" id="btn-home">
                <span class="icon">←</span>
                <span class="text" id="nav-back">返回</span>
            </a>
            <div class="header-center">
                <h1 id="app-title">笔顺训练</h1>
            </div>
            <div class="header-right">
                <button id="btn-settings" class="icon-btn" title="设置">⚙️</button>
                <div class="lang-switcher">
                    <button class="lang-btn active" data-lang="zh">中</button>
                    <button class="lang-btn" data-lang="en">En</button>
                </div>
            </div>
        </header>

        <!-- Game Stats -->
        <div class="game-stats">
            <div class="stat-item">
                <span class="stat-label" id="lbl-strokes">笔画</span>
                <span class="stat-value"><span id="strokes-done">0</span>/<span id="strokes-total">0</span></span>
            </div>
            <div class="stat-item timer">
                <span class="stat-label" id="lbl-time">剩余时间</span>
                <span class="stat-value" id="time-remaining">30</span>
            </div>
            <div class="stat-item">
                <span class="stat-label" id="lbl-score">得分</span>
                <span class="stat-value" id="score-value">0</span>
            </div>
        </div>

        <!-- Main Game Area -->
        <div class="game-container">
            <!-- Character Display (Left/Top on mobile) -->
            <div class="character-panel">
                <div class="character-display">
                    <canvas id="character-canvas"></canvas>
                    <div class="character-overlay" id="char-overlay">
                        <span id="target-character">大</span>
                    </div>
                </div>
                <div class="stroke-guide">
                    <p id="stroke-hint">第 1 笔：横</p>
                </div>
            </div>

            <!-- Camera/Writing Area (Center) - With embedded character -->
            <div class="writing-panel">
                <div class="camera-container">
                    <video id="camera-video" autoplay playsinline></video>
                    <canvas id="tracking-canvas"></canvas>
                    <!-- Embedded character overlay for tracing -->
                    <div class="embedded-character" id="embedded-character">
                        <span id="trace-character">大</span>
                    </div>
                    <!-- Stroke order guide overlay -->
                    <canvas id="stroke-guide-canvas"></canvas>
                    <canvas id="writing-canvas"></canvas>
                    <!-- Writing Zone Overlay -->
                    <div class="writing-zone">
                        <div class="zone-guide"></div>
                    </div>
                    <!-- Feedback X mark -->
                    <div id="wrong-mark" class="wrong-mark hidden">✕</div>
                    <!-- Correct checkmark -->
                    <div id="correct-mark" class="correct-mark hidden">✓</div>
                </div>
                <p class="writing-hint" id="writing-hint">在空中用手指书写笔画</p>
            </div>

            <!-- Bomb & Bucket Animation (Right/Bottom on mobile) -->
            <div class="animation-panel">
                <div class="bucket-container">
                    <div class="bucket" id="bucket">
                        <div class="bucket-rim"></div>
                        <div class="bucket-body">
                            <div class="water" id="water"></div>
                            <div class="bucket-ribs" aria-hidden="true"></div>
                        </div>
                        <div class="bucket-handle"></div>
                        <div class="bucket-grip" aria-hidden="true"></div>
                        <div class="bucket-label" aria-hidden="true">
                            <span>消防水</span>
                        </div>
                    </div>
                    <div class="water-drops hidden" id="water-drops">
                        <div class="drop"></div>
                        <div class="drop"></div>
                        <div class="drop"></div>
                        <div class="drop"></div>
                        <div class="drop"></div>
                    </div>
                </div>
                <div class="bomb-container" id="bomb-container">
                    <div class="bomb" id="bomb">
                        <div class="bomb-body">
                            <div class="bomb-highlight"></div>
                            <div class="bomb-rivets" aria-hidden="true"></div>
                            <div class="bomb-seam" aria-hidden="true"></div>
                            <div class="bomb-hazard" aria-hidden="true">
                                <svg viewBox="0 0 100 100" width="44" height="44" focusable="false" aria-hidden="true">
                                    <defs>
                                        <linearGradient id="hazG" x1="0" y1="0" x2="1" y2="1">
                                            <stop offset="0" stop-color="#ffd66b"/>
                                            <stop offset="1" stop-color="#ff9f1a"/>
                                        </linearGradient>
                                    </defs>
                                    <path d="M50 6 L96 90 H4 Z" fill="url(#hazG)" stroke="rgba(0,0,0,0.65)" stroke-width="4" />
                                    <path d="M50 22 C40 35, 52 42, 43 54 C35 65, 48 72, 39 82 C54 76, 66 67, 59 55 C52 44, 67 37, 50 22 Z"
                                          fill="rgba(15,15,15,0.92)"/>
                                    <rect x="46" y="70" width="8" height="8" rx="2" fill="rgba(15,15,15,0.92)"/>
                                </svg>
                            </div>
                        </div>
                        <div class="fuse" id="fuse">
                            <div class="fuse-line" id="fuse-line"></div>
                            <div class="fuse-ember" id="fuse-ember"></div>
                            <div class="spark-container" id="spark-container">
                                <div class="spark"></div>
                                <div class="spark"></div>
                                <div class="spark"></div>
                            </div>
                            <div class="smoke-trail"></div>
                        </div>
                        <div class="bomb-glow"></div>
                    </div>
                    <!-- Danger warning -->
                    <div class="danger-text" id="danger-text">DANGER</div>
                    
                    <div class="explosion hidden" id="explosion">
                        <!-- Fire particles -->
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <div class="explosion-particle"></div>
                        <!-- Debris -->
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <div class="debris"></div>
                        <!-- Smoke -->
                        <div class="smoke-cloud" style="left: -30px;"></div>
                        <div class="smoke-cloud" style="left: 0px; animation-delay: 0.15s;"></div>
                        <div class="smoke-cloud" style="left: 30px; animation-delay: 0.3s;"></div>
                    </div>
                </div>
                <div class="tilt-indicator">
                    <div class="tilt-bar" id="tilt-bar"></div>
                </div>
            </div>
        </div>

        <!-- Controls -->
        <div class="game-controls">
            <button id="btn-clear" class="control-btn">
                <span class="icon">🗑️</span>
                <span id="lbl-clear">清除</span>
            </button>
            <button id="btn-hint" class="control-btn">
                <span class="icon">💡</span>
                <span id="lbl-hint">提示</span>
            </button>
            <button id="btn-skip" class="control-btn">
                <span class="icon">⏭️</span>
                <span id="lbl-skip">跳过</span>
            </button>
        </div>
    </div>

    <!-- Result Modal -->
    <div id="result-modal" class="modal hidden">
        <div class="modal-content result-content">
            <div class="result-icon" id="result-icon">🎉</div>
            <h2 class="result-title" id="result-title">恭喜完成！</h2>
            <p class="result-message" id="result-message">你成功写出了正确的笔顺！</p>
            <div class="result-stats">
                <div class="result-stat">
                    <span class="result-label" id="res-char-label">汉字</span>
                    <span class="result-value" id="res-character">大</span>
                </div>
                <div class="result-stat">
                    <span class="result-label" id="res-time-label">用时</span>
                    <span class="result-value" id="res-time">15秒</span>
                </div>
                <div class="result-stat">
                    <span class="result-label" id="res-accuracy-label">准确率</span>
                    <span class="result-value" id="res-accuracy">100%</span>
                </div>
            </div>
            <div class="result-buttons">
                <button id="btn-retry" class="btn-secondary">
                    <span id="lbl-retry">再试一次</span>
                </button>
                <button id="btn-next-char" class="btn-primary">
                    <span id="lbl-next">下一个字</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal hidden">
        <div class="modal-content settings-content">
            <button class="close-modal" id="close-settings">&times;</button>
            <h2 id="settings-title">设置</h2>
            
            <div class="setting-group">
                <label id="lbl-difficulty">难度</label>
                <div class="setting-options">
                    <button class="option-btn active" data-difficulty="easy" id="diff-easy">简单</button>
                    <button class="option-btn" data-difficulty="normal" id="diff-normal">普通</button>
                    <button class="option-btn" data-difficulty="hard" id="diff-hard">困难</button>
                </div>
            </div>

            <div class="setting-group">
                <label id="lbl-char-set">字库</label>
                <div class="setting-options">
                    <button class="option-btn active" data-charset="basic" id="charset-basic">基础字</button>
                    <button class="option-btn" data-charset="common" id="charset-common">常用字</button>
                    <button class="option-btn" data-charset="hsk1" id="charset-hsk1">HSK1</button>
                </div>
            </div>

            <div class="setting-group">
                <label id="lbl-input-mode">输入模式</label>
                <div class="setting-options">
                    <button class="option-btn" data-input="camera" id="input-camera">摄像头</button>
                    <button class="option-btn active" data-input="touch" id="input-touch">触屏/鼠标</button>
                </div>
            </div>

            <div class="setting-group">
                <label id="lbl-timer">时间限制</label>
                <div class="setting-options">
                    <button class="option-btn" data-timer="15">15秒</button>
                    <button class="option-btn active" data-timer="30">30秒</button>
                    <button class="option-btn" data-timer="60">60秒</button>
                    <button class="option-btn" data-timer="0" id="timer-off">无限</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Select Modal -->
    <div id="char-select-modal" class="modal hidden">
        <div class="modal-content char-select-content">
            <button class="close-modal" id="close-char-select">&times;</button>
            <h2 id="char-select-title">选择练习汉字</h2>
            <div class="char-grid" id="char-grid">
                <!-- Characters will be inserted here -->
            </div>
            <button id="btn-random-char" class="btn-primary">
                <span id="lbl-random">随机选择</span>
            </button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module" src="js/stroke-data.js"></script>
    <script type="module" src="js/main.js"></script>

    <!-- Fullscreen FX canvas (explosion / shockwave / particles) -->
    <canvas id="fx-canvas" class="fx-canvas" aria-hidden="true"></canvas>
</body>
</html>

